{% extends "frontend/base.html" %}
{% block content %}

<div class="card flat mb-3" style="background: var(--bg-alt);">
  <h2 style="font-size: 1.35rem; margin-bottom: 4px;">Recent Analysis Results</h2>
  <p class="muted text-sm mb-0">Detailed breakdown of your most recent assessment outputs.</p>
</div>

<div id="resultsList" class="row card-grid" style="gap: 20px;">
  <div class="text-center muted" style="padding: 40px 0; width: 100%;">Loading analysis data...</div>
</div>
{% endblock %}

{% block scripts %}
<script>
  requireAuthOrRedirect();

  function riskBadge(risk) {
    return '<span class="badge ' + (risk||"").toLowerCase() + '">' + risk + '</span>';
  }

  async function loadResults() {
    const res = await apiFetch("/analysis/results/", { method: "GET" });
    if (!res.ok) return;
    const items = await res.json();
    const el = document.getElementById("resultsList");

    if (!items.length) {
      el.innerHTML = '<div class="card text-center muted" style="width:100%;">No results found. Start an assessment to see data.</div>';
      return;
    }

    el.innerHTML = items.map(function(item) {
      return '<div style="flex:1; min-width:320px; max-width:100%;"><div class="card">' +
        '<div class="flex justify-between items-start mb-3"><div><div class="text-sm fw-semi text-accent mb-1">SESSION #' + item.session + '</div><h4 class="mb-0">' + new Date(item.created_at).toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'}) + '</h4></div>' + riskBadge(item.risk_level) + '</div>' +
        '<div class="flex gap-md mb-3">' +
          '<div class="text-center flex-1"><div class="fw-bold">' + item.stress_score + '</div><div class="text-xs muted">Stress</div></div>' +
          '<div class="text-center flex-1" style="border-left:1px solid var(--border); border-right:1px solid var(--border);"><div class="fw-bold">' + item.anxiety_score + '</div><div class="text-xs muted">Anxiety</div></div>' +
          '<div class="text-center flex-1"><div class="fw-bold">' + item.depression_score + '</div><div class="text-xs muted">Depr.</div></div>' +
        '</div>' +
        '<div class="text-sm mb-3" style="padding:12px; background:var(--bg-alt); border-radius:8px;"><div class="fw-semi mb-1">Clinical Rationale</div><div class="muted">' + item.rationale_short + '</div></div>' +
        '<div class="fw-semi text-sm text-accent mb-1">KEY RECOMMENDATIONS</div>' +
        '<ul class="text-sm muted" style="padding-left:18px; margin:0;">' + (item.recommendations||[]).map(function(r){return '<li>'+r+'</li>';}).join("") + '</ul>' +
      '</div></div>';
    }).join("");
  }
  loadResults();
</script>
{% endblock %}
