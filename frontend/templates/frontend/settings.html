{% extends "frontend/base.html" %}
{% block content %}

<div class="card flat mb-3" style="background: var(--bg-alt);">
  <h2 style="font-size: 1.35rem; margin-bottom: 4px;">Emergency Alert Protocol</h2>
  <p class="muted text-sm mb-0">Manage your crisis contacts and automated intervention settings.</p>
</div>

<div class="row app-grid" style="gap: 24px;">
  <!-- Consent -->
  <div class="flex-1" style="min-width: 280px;">
    <div class="card">
      <h4 class="mb-2">Wellness Consent</h4>
      <p class="muted text-sm mb-3">By enabling alerts, our AI will automatically notify your emergency contacts if a
        high-risk or critical event is detected during your assessments.</p>
      <label class="toggle-switch mb-2">
        <input type="checkbox" id="consentToggle">
        <span class="toggle-track"></span>
        <span class="fw-semi text-sm">Enable Automated Intervention</span>
      </label>
      <div id="consentStatus" class="alert hidden mb-2"></div>
      <button id="saveProfileBtn" class="btn btn-accent btn-full mt-2">Save Preferences</button>
    </div>
  </div>

  <!-- Contacts -->
  <div class="flex-1" style="min-width: 280px;">
    <div class="card">
      <div class="flex justify-between items-center mb-3">
        <h4 class="mb-0">Crisis Contacts</h4>
        <button id="addContactBtn" class="btn btn-outline btn-sm">Add New</button>
      </div>
      <div id="contactsList" class="muted text-sm text-center"
        style="padding: 24px 0; background: var(--bg-alt); border-radius: var(--radius-md);">
        Loading contact records...
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="contactModalOverlay">
  <div class="modal-box">
    <div class="modal-header">
      <h5>New Crisis Contact</h5>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Contact Name</label><input id="contactName" class="form-input"
          type="text" placeholder="e.g. Spouse, Clinician"></div>
      <div class="form-group"><label class="form-label">Notification Channel</label><select id="contactChannel"
          class="form-select">
          <option value="EMAIL">Email Address</option>
          <option value="WEBHOOK">System Webhook (Advanced)</option>
        </select></div>
      <div class="form-group"><label class="form-label">Destination</label><input id="contactDest" class="form-input"
          type="text" placeholder="email@example.com"></div>
      <div class="flex gap-sm">
        <button class="btn btn-outline flex-1" id="cancelModalBtn">Cancel</button>
        <button id="saveContactBtn" class="btn btn-accent flex-1">Add Contact</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  requireAuthOrRedirect();

  const consentToggle = document.getElementById("consentToggle");
  const consentStatus = document.getElementById("consentStatus");
  const contactsList = document.getElementById("contactsList");
  const modalOverlay = document.getElementById("contactModalOverlay");

  function openModal() { modalOverlay.classList.add("open"); }
  function closeModal() { modalOverlay.classList.remove("open"); }

  async function loadSettings() {
    const res = await apiFetch("/profile/me/", { method: "GET" });
    if (!res.ok) return;
    const profile = await res.json();
    consentToggle.checked = profile.consent_alerts_enabled;
    updateConsentUI();
    await loadContacts();
  }

  function updateConsentUI() {
    consentStatus.classList.remove("hidden");
    if (consentToggle.checked) {
      consentStatus.className = "alert alert-ok";
      consentStatus.textContent = "Protocol Active: High-risk detections will trigger alerts.";
    } else {
      consentStatus.className = "alert alert-warn";
      consentStatus.textContent = "Intervention Paused: Alerts will not be sent.";
    }
  }

  async function loadContacts() {
    const res = await apiFetch("/alerts/contacts/", { method: "GET" });
    if (!res.ok) return;
    const contacts = await res.json();
    if (!contacts.length) {
      contactsList.innerHTML = '<p class="muted mb-0">No contacts registered for crisis support.</p>';
      return;
    }
    contactsList.style.padding = "0"; contactsList.style.background = "transparent";
    contactsList.innerHTML = contacts.map(function (c) {
      return '<div class="contact-item"><div><div class="fw-semi">' + c.name + '</div><div class="text-sm muted">' + c.destination + ' (' + c.channel + ')</div></div>' +
        '<div class="d-flex align-items-center gap-3"><label class="toggle-switch"><input type="checkbox" ' + (c.enabled ? 'checked' : '') + ' onchange="toggleContact(' + c.id + ', this.checked)"><span class="toggle-track"></span></label>' +
        '<button class="btn-icon-delete" onclick="deleteContact(' + c.id + ')" title="Remove contact">' +
        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6m3 0V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg></button></div></div>';
    }).join("");
  }

  async function toggleContact(id, enabled) {
    await apiFetch("/alerts/contacts/" + id + "/", { method: "PATCH", body: JSON.stringify({ enabled: enabled }) });
  }

  async function deleteContact(id) {
    if (!confirm("Are you sure you want to remove this contact?")) return;
    const res = await apiFetch("/alerts/contacts/" + id + "/", { method: "DELETE" });
    if (res.ok) {
      showToast("Removed", "Contact has been removed.", "ok");
      await loadContacts();
    }
  }

  document.getElementById("saveProfileBtn").addEventListener("click", async function () {
    var btn = document.getElementById("saveProfileBtn");
    setBtnLoading(btn, true, "Saving...");
    var res = await apiFetch("/profile/me/", { method: "PATCH", body: JSON.stringify({ consent_alerts_enabled: consentToggle.checked }) });
    setBtnLoading(btn, false, "Save Preferences");
    if (res.ok) { showToast("Updated", "Your preferences have been applied.", "ok"); updateConsentUI(); }
  });

  document.getElementById("addContactBtn").addEventListener("click", openModal);
  document.getElementById("cancelModalBtn").addEventListener("click", closeModal);
  modalOverlay.addEventListener("click", function (e) { if (e.target === modalOverlay) closeModal(); });

  document.getElementById("saveContactBtn").addEventListener("click", async function () {
    var btn = document.getElementById("saveContactBtn");
    var name = document.getElementById("contactName").value.trim();
    var channel = document.getElementById("contactChannel").value;
    var destination = document.getElementById("contactDest").value.trim();
    if (!name || !destination) return;
    setBtnLoading(btn, true, "Adding...");
    var res = await apiFetch("/alerts/contacts/", { method: "POST", body: JSON.stringify({ name: name, channel: channel, destination: destination, enabled: true }) });
    setBtnLoading(btn, false, "Add Contact");
    if (res.ok) { closeModal(); await loadContacts(); showToast("Success", "Emergency contact added.", "ok"); }
  });

  loadSettings();
</script>
{% endblock %}