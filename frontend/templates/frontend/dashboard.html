{% extends "frontend/base.html" %}
{% block content %}
<div class="card">
  <h2>Dashboard</h2>
  <p class="muted">Trends over time based on your analysis history.</p>
  <div class="row">
    <div>
      <label class="label">Range (days)</label>
      <select id="daysSelect" class="select">
        <option value="7">7</option>
        <option value="30" selected>30</option>
        <option value="90">90</option>
      </select>
    </div>
    <div style="display:flex;align-items:flex-end;">
      <button id="loadBtn" class="btn btn-primary">Load</button>
    </div>
  </div>
</div>

<div class="grid grid-2">
  <div class="card"><canvas id="scoresChart"></canvas></div>
  <div class="card"><canvas id="riskChart"></canvas></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  requireAuthOrRedirect();

  let scoresChart = null;
  let riskChart = null;

  async function loadMetrics() {
    const days = document.getElementById("daysSelect").value;
    const res = await apiFetch(`/dashboard/metrics/?days=${days}`, { method: "GET" });
    if (!res.ok) return;

    const data = await res.json();
    const points = data.points || [];

    const labels = points.map(p => p.date);
    const stress = points.map(p => p.stress_avg);
    const anxiety = points.map(p => p.anxiety_avg);
    const depression = points.map(p => p.depression_avg);
    const overall = points.map(p => p.overall_avg);

    const highCount = points.map(p => p.high_count);
    const criticalCount = points.map(p => p.critical_count);

    if (scoresChart) scoresChart.destroy();
    if (riskChart) riskChart.destroy();

    scoresChart = new Chart(document.getElementById("scoresChart"), {
      type: "line",
      data: {
        labels,
        datasets: [
          { label: "Stress", data: stress },
          { label: "Anxiety", data: anxiety },
          { label: "Depression", data: depression },
          { label: "Overall", data: overall },
        ]
      }
    });

    riskChart = new Chart(document.getElementById("riskChart"), {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "High Count", data: highCount },
          { label: "Critical Count", data: criticalCount },
        ]
      }
    });
  }

  document.getElementById("loadBtn").addEventListener("click", loadMetrics);
  loadMetrics();
</script>
{% endblock %}

