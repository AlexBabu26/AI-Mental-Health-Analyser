{% extends "frontend/base.html" %}
{% block content %}
<div class="row app-grid" style="gap: 24px;">
  <!-- Left: Chat -->
  <div class="flex-1" style="min-width: 0;">
    <div class="card mb-3">
      <div class="flex justify-between items-center mb-3">
        <div>
          <h2 style="font-size: 1.35rem; margin-bottom: 4px;">Clinical Assessment</h2>
          <p class="muted text-sm mb-0">Speak naturally about how you've been feeling lately.</p>
        </div>
        <div class="flex gap-sm items-center">
          <select id="sessionSelect" class="form-select" style="width: auto; padding: 6px 10px; font-size: 13px;"></select>
          <button id="newSessionBtn" class="btn btn-accent btn-sm">New</button>
        </div>
      </div>
      <div id="chatBox" class="chat-box mb-2"></div>
      <div class="chat-input-row">
        <input id="msgInput" class="form-input" placeholder="Share your thoughts here...">
        <button id="sendBtn" class="btn btn-accent">Send</button>
      </div>
      <p id="chatMsg" class="muted text-sm mt-1"></p>
    </div>
  </div>

  <!-- Right: Analysis -->
  <div style="flex: 0 0 340px; max-width: 100%;">
    <div class="card mb-3">
      <h4 class="mb-2">Live Analysis</h4>
      <div id="analysisCard" class="muted text-sm">Send a message to begin the analysis.</div>
      <hr>
      <h4 class="mb-2">Alert Protocol</h4>
      <div id="alertCard" class="muted text-sm">No emergency events detected.</div>
    </div>
    <div class="card flat bg-alt">
      <h5 class="mb-1">Assessment Tips</h5>
      <ul class="text-sm muted" style="padding-left: 18px;">
        <li>Try to be as specific as possible about your symptoms.</li>
        <li style="margin-top: 6px;">Describe patterns you've noticed over the last 2 weeks.</li>
        <li style="margin-top: 6px;">All conversations are encrypted and private.</li>
      </ul>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  requireAuthOrRedirect();

  const chatBox = document.getElementById("chatBox");
  const sessionSelect = document.getElementById("sessionSelect");
  const analysisCard = document.getElementById("analysisCard");
  const alertCard = document.getElementById("alertCard");
  const chatMsg = document.getElementById("chatMsg");
  let currentSessionId = null;

  function bubble(text, who) {
    const div = document.createElement("div");
    div.className = "bubble " + who;
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function riskBadge(risk) {
    return '<span class="badge ' + (risk || "").toLowerCase() + '">' + risk + '</span>';
  }

  async function loadSessions() {
    const res = await apiFetch("/chat/sessions/", { method: "GET" });
    if (!res.ok) { sessionSelect.innerHTML = "<option>Error</option>"; return; }
    const sessions = await res.json();
    sessionSelect.innerHTML = "";
    if (!sessions.length) { await createSession(); return; }
    sessions.forEach(function(s) {
      var opt = document.createElement("option");
      opt.value = s.id; opt.textContent = "Session #" + s.id;
      sessionSelect.appendChild(opt);
    });
    currentSessionId = sessions[0].id;
    sessionSelect.value = currentSessionId;
    await loadMessages(currentSessionId);
  }

  async function createSession() {
    const res = await apiFetch("/chat/sessions/", { method: "POST", body: JSON.stringify({}) });
    if (!res.ok) return;
    await loadSessions();
  }

  async function loadMessages(sessionId) {
    chatBox.innerHTML = "";
    const res = await apiFetch("/chat/sessions/" + sessionId + "/messages/", { method: "GET" });
    if (!res.ok) return;
    const msgs = await res.json();
    msgs.forEach(function(m) { bubble(m.content, m.sender === "USER" ? "user" : "ai"); });
  }

  async function sendMessage() {
    const text = document.getElementById("msgInput").value.trim();
    if (!text || !currentSessionId) return;
    document.getElementById("msgInput").value = "";
    bubble(text, "user");
    bubble("...", "ai");
    chatMsg.textContent = "Clinical engine processing...";

    const res = await apiFetch("/chat/sessions/" + currentSessionId + "/send/", {
      method: "POST", body: JSON.stringify({ content: text })
    });
    if (chatBox.lastChild) chatBox.removeChild(chatBox.lastChild);
    if (!res.ok) { chatMsg.textContent = "Connection error."; return; }

    const data = await res.json();
    bubble(data.ai_message.content, "ai");
    chatMsg.textContent = "";

    const a = data.analysis;
    analysisCard.innerHTML =
      '<div class="mb-2">Level: ' + riskBadge(a.risk_level) + '</div>' +
      '<div class="flex gap-md mb-2">' +
        '<div class="text-center flex-1"><div class="fw-bold">' + a.stress_score + '</div><div class="text-xs muted">Stress</div></div>' +
        '<div class="text-center flex-1" style="border-left:1px solid var(--border); border-right:1px solid var(--border);"><div class="fw-bold">' + a.anxiety_score + '</div><div class="text-xs muted">Anxiety</div></div>' +
        '<div class="text-center flex-1"><div class="fw-bold">' + a.depression_score + '</div><div class="text-xs muted">Depr.</div></div>' +
      '</div>' +
      '<div class="text-sm bg-alt" style="padding:8px 12px; border-radius:8px; margin-bottom:12px;">Overall: <strong>' + a.overall_score + '</strong></div>' +
      '<div class="fw-semi text-sm mb-1">Recommendations</div>' +
      '<ul class="text-sm muted" style="padding-left:18px;">' + (a.recommendations || []).map(function(r){return '<li>'+r+'</li>';}).join("") + '</ul>';

    var al = data.alert;
    if (!al) {
      alertCard.innerHTML = '<div class="alert alert-ok">Standard wellness observed.</div>';
    } else {
      alertCard.innerHTML =
        '<div class="alert alert-danger mb-1"><strong>' + al.status + '</strong>: Internal threshold met.</div>' +
        '<div class="text-sm muted">Protocol: ' + al.risk_level + ' Notification</div>' +
        '<div class="text-sm muted">Contacts: ' + ((al.sent_to || []).join(", ") || "None") + '</div>';
    }
  }

  sessionSelect.addEventListener("change", async function() { currentSessionId = sessionSelect.value; await loadMessages(currentSessionId); });
  document.getElementById("newSessionBtn").addEventListener("click", createSession);
  document.getElementById("sendBtn").addEventListener("click", sendMessage);
  document.getElementById("msgInput").addEventListener("keydown", function(e) { if (e.key === "Enter") sendMessage(); });
  loadSessions();
</script>
{% endblock %}
