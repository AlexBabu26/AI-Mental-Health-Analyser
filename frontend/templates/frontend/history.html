{% extends "frontend/base.html" %}
{% block content %}

<div class="card flat mb-3" style="background: var(--bg-alt);">
  <h2 style="font-size: 1.35rem; margin-bottom: 4px;">Assessment Records</h2>
  <p class="muted text-sm mb-0">View your full interaction history and historical analysis snapshots.</p>
</div>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Date & Time</th>
        <th>Type</th>
        <th>Summary</th>
        <th>Risk Level</th>
      </tr>
    </thead>
    <tbody id="historyTableBody">
      <tr>
        <td colspan="4" class="text-center muted" style="padding: 40px 20px;">Curating your records...</td>
      </tr>
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
  requireAuthOrRedirect();

  function riskBadge(risk) {
    return '<span class="badge ' + (risk || "").toLowerCase() + '">' + risk + '</span>';
  }

  async function loadHistory() {
    const res = await apiFetch("/analysis/results/", { method: "GET" });
    if (!res.ok) return;
    const data = await res.json();
    const items = data.results || [];
    const el = document.getElementById("historyTableBody");

    if (!items.length) {
      el.innerHTML = '<tr><td colspan="4" class="text-center muted" style="padding:40px 20px;">No interaction records found.</td></tr>';
      return;
    }

    el.innerHTML = items.map(function (item) {
      return '<tr>' +
        '<td><div class="fw-semi">' + new Date(item.created_at).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' }) + '</div><div class="text-xs muted">' + new Date(item.created_at).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' }) + '</div></td>' +
        '<td class="text-sm fw-semi text-accent">SESSION #' + item.session + '</td>' +
        '<td class="text-sm muted" style="max-width:300px;"><div style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">' + item.rationale_short + '</div></td>' +
        '<td>' + riskBadge(item.risk_level) + '</td></tr>';
    }).join("");
  }
  loadHistory();
</script>
{% endblock %}